<!DOCTYPE html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<style>
body  { font-family:"Segoe UI",Arial; line-height:1.5; font-size:16px; margin:0; padding:0; overflow:hidden }
header { background: linear-gradient(to bottom right, #06c, #fc0); }
header { color:#eee; padding:12px; font-size:20px; height:45px }
#left  { float:left;  width:calc(100vw - 495px); height:calc(100vh - 100px); }
#right { float:right; width:460px; height:calc(100vh - 100px); } 
#left, #prompt, #list { border:1px solid grey; padding:6px; overflow:auto }
#list li:hover { background:#eee }
#right textarea { display:block; width:96%; margin:3px auto; background:#eee}
.prompt { color:SlateBlue; background:#eee; padding:6px; }

@media print{
  #menu, #right { display:none!important }
  #left { position:relative; width:100%; left:0px; top:0px; border:none; height:auto; overflow:hidden }
  .prompt { border-bottom: 1px solid grey }
}
@media screen and (max-width: 880px) {
  #list, #message { display:none!important }
  #right { width:100%; height:auto;  }
  #left	 { width:98%; height:calc(100vh - 160px);  }
}
</style>

<header>
  <div id=heading style="float:left">Vanilla ChatGPT<br>
    <span id=message style="color:yellow;font-size:10px">
        <a href="https://github.com/casualwriter/vanilla-chatgpt" target=_NEW>github</a> @20230328b
    </span>
  </div>
  <div id=menu style="float:right;">
    <button onclick="chat.logout()">Logout</button> 
    <button onclick="chat.clear()">Clear</button>
    <button onclick="chat.export()" >Export</button>
    <button id=btnSent accesskey=s onclick="chat.submit()" title="Ctrl-Enter or Alt-S to send">Send</button>
  </div>
</header>

<div id="content" style="margin:8px;">
  <div id="right">
     <textarea id=prompt rows=3 placeholder="please input prompt here..<ctrl-enter> to send"></textarea>
     <div id="list" style="height:calc(100vh - 163px)">
        <b>Samples of prompt</b>
        <ul>
          <li>please list pro & con of vanilla javascript
          <li>Please translate the following text into ..
          <li>Please list in table for 10 famous painters
          <li>code a function to get string token by javascript
        </ul>
     </div>
  </div>
  <div id="left">
    <div id="main" style="padding:8px; max-width:1024px">
       <h3>Welcome to vanilla-chatgpt.</h3> 
       <p>please input your API key to start. <p>input prompt and press <b>[ctrl-enter] to submit</b>, 
       <p>[ctrl-p] to print <p>[export] to export conversation <p> [logout] to clear the API key
    </div>
  </div>
</div>

<link rel="stylesheet" href="casual-markdown@0.91.css">
<script src="casual-markdown@0.91.js"></script>
<script src="vanilla-chatgpt.js"></script>

<script>
//================= main program ===================
// display result when receiving message
chat.onmessage = function (text) {
  chat("message").innerHTML = 'receiving messages..'
  chat("receiving").innerHTML = md.html(text + '<br><br><br>');
}

// show whole conversation when message completed
chat.oncomplete = (text) => {
  let html1='', html2=''
  chat("message").innerHTML = `(model: ${chat.model})`
  chat.history.push( { prompt: chat.prompt, result: chat.result } )
  
  for (let i=0; i<chat.history.length; i++) {
     html1 += '<h4 class=prompt id=prompt'+i+'>' + chat.history[i].prompt + '</h4>\n'
     html1 += chat.history[i].result + '\n\n'
     html2 += '<li onclick="location=this.title" title="#prompt' + i + '">' + chat.history[i].prompt
  }
  
  chat("main").innerHTML = md.html( html1 + '<br><br><br>' )
  chat("list").innerHTML = html2
  chat("left").scrollTop = chat("left").scrollHeight;
  chat('prompt').value = ''
  chat('prompt').focus();
  chat("btnSent").innerText = 'Send'
}

// abort fetch request.
chat.abort = () => { 
  chat.controller.abort()
  chat("receiving").innerHTML += '\n<font color=red>Message Aborted!</font>'
  chat("receiving").id = 'abort';
};

// clear conversation history
chat.clear = () => { 
  if (confirm( 'Clear chat history?')) {
    chat.history= [] 
    chat("list").innerHTML = chat("main").innerHTML = ''
  }
}  

// submit prompt
chat.submit = function() {
  if (chat("btnSent").innerText === 'Stop..') {
    chat.abort()
    chat("btnSent").innerText = 'Send'
  } else {
    chat.stream( chat.prompt = chat('prompt').value )
    chat("main").innerHTML += '<h4 class=prompt>' + chat.prompt + '</h4>\n<div id=receiving>Receiving....</div>'
    chat("left").scrollTop = chat("left").scrollHeight;
    chat("btnSent").innerText = 'Stop..'
  }  
}

// prompt for API key if not found in localStorage
window.onload = function () {
  chat.apiKey = localStorage.getItem('OPENAI_API_KEY');
  if (!chat.apiKey || chat.apiKey.length < 10 ) {
     chat.apiKey = prompt("Please input Secret API key (will store in local.storage)", "sk-");
     localStorage.setItem('OPENAI_API_KEY', chat.apiKey)
  }
  chat('prompt').focus();
}

// add submit hot-key of ctrl-enter
document.addEventListener('keydown', function(event) {
  if (event.ctrlKey && event.key === 'Enter') chat.submit()
});

// handle default prompt list
document.querySelectorAll('#list li').forEach( (element) => {
  element.addEventListener('click', (event) => {
    chat('prompt').innerText = element.innerText
    chat('prompt').focus();
  });
});
</script>
